use hui
use tsunami


func get_part(Song s, int offset) -> TrackMarker*
	let t = s.time_track()
	if !t
		return nil
	for m in weak(t.layers[0].markers)
		if m.range.inside(offset)
			return m
	return nil



class PLPanel extends ConfigPanel
	PracticeLooper* looper
	
	func __init__(PracticeLooper l)
		super.__init__(l)
		from_source("
Grid ? '' vertical
	Grid ? ''
		Button play 'Play' expandx expandy
		Button pause 'Pause' expandx expandy
	Grid ? ''
		Label ? 'Speed'
		SpinButton speed '1.0' range=0:1:0.01
		Button set 'Set'")
		looper = &l

		event("play", on_play)
		event("pause", on_pause)
		event("set", on_set_speed)
	
	func on_play()
		looper.play()
	func on_pause()
		looper.pause()
	func on_set_speed()
		looper.set_speed(get_float("speed"))


func scale_range(Range r, float s) -> Range
	return RangeTo(r.start() * s, r.end() * s)


class PracticeLooper extends TsunamiPlugin
	int runner
	SignalChain* chain
	SongRenderer* renderer
	Song* song
	bool altered_speed = false
	float current_speed = 1
	Range old_sel
	
	func override on_start()
		song = session.song
		chain = session.view.signal_chain
		renderer = session.view.renderer
#		runner = hui.run_repeated(0.05, self, on_update)
		
	func override on_stop()
#		hui.cancel_runner(runner)
		reset()
			
	func override create_panel() -> ConfigPanel*
		return new PLPanel(self)
	
	func play()
		session.view.play()
		return
		print(session.view.sel.range())
		session.view.prepare_playback(session.view.sel.range(), true)
		#renderer.set_range(session.view.sel.range())
		renderer.set_loop(true)
		#chain.command(Module.Command.PREPARE_START, 0)
		chain.start()
	
	func pause()
		chain.stop()
	
	func reset()
		if not altered_speed
			return
		print("UNDO")
		session.view.sel.range_raw = old_sel
		session.view.cam.set_range(scale_range(session.view.cam.range(), current_speed))
		song.undo()
		altered_speed = false
		current_speed = 1
	
	func set_speed(float speed)
		if altered_speed
			reset()
		song.begin_action_group()
		for b,i in song.bars
			Bar bb
			bb.beats = b.beats
			bb.divisor = b.divisor
			bb.length = b.length / speed
			song.edit_bar(i, bb, Bar.EditMode.STRETCH_AND_SCALE_AUDIO)
		song.end_action_group()
		old_sel = session.view.sel.range_raw
		session.view.cam.set_range(scale_range(session.view.cam.range(), 1. / speed))
		session.view.sel.range_raw = scale_range(session.view.sel.range_raw, 1. / speed)
		session.view.update_selection()
		altered_speed = true
		current_speed = speed
